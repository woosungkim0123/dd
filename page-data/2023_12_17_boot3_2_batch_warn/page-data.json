{"componentChunkName":"component---src-templates-post-template-tsx","path":"/2023_12_17_boot3_2_batch_warn/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h1>현재 상황 (최신순)</h1>\n<h3>2024년 2월 22일</h3>\n<p>5.2 버전에서 수정될 예정이고 현재 5.1.1 버전에서는 JobRegistrySmartInitializingSingleton을 사용하여 이 문제를 해결할 수 있는 대체 방법을 제공하는 것으로 확인되었습니다.</p>\n<p><a href=\"https://github.com/spring-projects/spring-batch/releases/tag/v5.1.1\" target=\"_blank\"><strong>Spring Batch v5.1.1 릴리즈 노트</strong></a></p>\n<h3>2023년 12월 19일</h3>\n<p><code class=\"language-text\">JobRegistryBeanPostProcessor</code> Bean이 자동으로 등록되는 것을 방지함으로써 문제를 해결하실 수 있습니다.</p>\n<p>기존 해결방법을 모두 제거하고 해당 내용으로 수정하였습니다.</p>\n<h3>2023년 12월 17일</h3>\n<p>Spring Boot 3.2에서 Batch를 사용할 때 발생하는 BeanPostProcessorChecker 경고와 관련된 명확한 해결책이나 패치는 아직 제공되지 않았습니다. 이 문제에 대한 추가 정보가 나오는 대로 본 글을 업데이트할 예정입니다.</p>\n<p><a href=\"https://github.com/spring-projects/spring-batch/issues/4519\" target=\"_blank\"><strong>Spring Batch Issue#4519</strong></a></p>\n<h1>문제</h1>\n<p>Spring Boot 3.2.0 버전에서 Batch를 사용할 때, 다음과 같은 경고 로그가 다수 발생하는 것을 확인했습니다. 전체 로그는 로그 요약 섹션에서 확인하실 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"vbnet\"><pre class=\"language-vbnet\"><code class=\"language-vbnet\">trationDelegate$BeanPostProcessorChecker <span class=\"token punctuation\">:</span> Bean <span class=\"token comment\">'org.springframework.boot.autoconfigure.jdbc.DataSourceConfiguration$Hikari' of type [org.springframework.boot.autoconfigure.jdbc.DataSourceConfiguration$Hikari] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying). Is this bean getting eagerly injected into a currently created BeanPostProcessor [jobRegistryBeanPostProcessor]? Check the corresponding BeanPostProcessor declaration and its </span></code></pre></div>\n<center>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ef3032a3928b3048925f65c45b6b6a4a/93f4b/boot_3_2_warn_1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 14.583333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAd0lEQVR42k2OWRIEIQhDPVOryOL9r5VJtKtrPl4FwQTa3htVIrDTEZ4Yo8PD8WTi4bwT1YPki3xrGcyMuo7anGgaXOoGRsF9IWjqogqT88NfmLToWe48YGAyTNqKhvshiHObn40yLPZNJl2jmj2PuGGfL7+3DvkBGixj5tvpyUsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/ef3032a3928b3048925f65c45b6b6a4a/a59e9/boot_3_2_warn_1.webp 192w,\n/static/ef3032a3928b3048925f65c45b6b6a4a/0ca9f/boot_3_2_warn_1.webp 384w,\n/static/ef3032a3928b3048925f65c45b6b6a4a/dc9b9/boot_3_2_warn_1.webp 768w,\n/static/ef3032a3928b3048925f65c45b6b6a4a/e2c2f/boot_3_2_warn_1.webp 1152w,\n/static/ef3032a3928b3048925f65c45b6b6a4a/c7675/boot_3_2_warn_1.webp 1371w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/ef3032a3928b3048925f65c45b6b6a4a/3b721/boot_3_2_warn_1.png 192w,\n/static/ef3032a3928b3048925f65c45b6b6a4a/66595/boot_3_2_warn_1.png 384w,\n/static/ef3032a3928b3048925f65c45b6b6a4a/fe486/boot_3_2_warn_1.png 768w,\n/static/ef3032a3928b3048925f65c45b6b6a4a/d2d74/boot_3_2_warn_1.png 1152w,\n/static/ef3032a3928b3048925f65c45b6b6a4a/93f4b/boot_3_2_warn_1.png 1371w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/ef3032a3928b3048925f65c45b6b6a4a/fe486/boot_3_2_warn_1.png\"\n            alt=\"BeanPostProcessorChecker Warn\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n</center>\r\n<br>\n<h2>발생 환경</h2>\n<ul>\n<li>Spring Boot 3.2.0 (JDK 17, 21)</li>\n<li>Spring Batch 5.1</li>\n</ul>\n<h2>해결책</h2>\n<p>Spring Boot 3.2와 Spring Batch 5.0 이상에서 발생하는 문제의 근본 원인은 <code class=\"language-text\">JobRegistryBeanPostProcessor</code>가 자동으로 설정되기 때문입니다. 이 문제는 <a href=\"https://github.com/spring-projects/spring-batch/issues/4245\" target=\"_blank\"><strong>Spring Batch Issue#4245</strong></a>에서 소개된 변경 사항에 기인합니다.</p>\n<p>이 변경으로 인해 <code class=\"language-text\">JobRegistryBeanPostProcessor</code>가 자동으로 등록되면서, 일부 빈들이 BeanPostProcessor의 처리를 완전히 받기 전에 초기화를 시도하는 문제가 발생하며, 이로 인해 경고 메시지가 발생합니다.</p>\n<blockquote>\n<p>JobRegistryBeanPostProcessor는 Spring Batch에서 JobRegistry와 관련된 빈들을 자동으로 등록하는 역할을 합니다.</p>\n</blockquote>\n<br>\n<h3>JobRegistryBeanPostProcessor 빈의 자동 등록 방지</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\r\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">BatchWarningConfig</span> <span class=\"token punctuation\">{</span>\r\n\r\n    <span class=\"token annotation punctuation\">@Bean</span>\r\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">BeanDefinitionRegistryPostProcessor</span> <span class=\"token function\">jobRegistryBeanPostProcessorRemover</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">return</span> registry <span class=\"token operator\">-></span> registry<span class=\"token punctuation\">.</span><span class=\"token function\">removeBeanDefinition</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"jobRegistryBeanPostProcessor\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Spring Boot 3.2.0 버전을 사용해야 하는 필수적인 이유가 없다면, 3.1.x 버전대를 사용하는 것이 더 적절할 것입니다. 3.1.x 버전에서는 이러한 경고가 발생하지 않습니다.</p>\n<p>참고로, 현재 Spring Boot의 <code class=\"language-text\">Batch</code>뿐만 아니라 <code class=\"language-text\">web-services</code>에서도 비슷한 문제가 발생하고 있습니다 - <a href=\"https://github.com/spring-projects/spring-ws/issues/1391\" target=\"_blank\"><strong>spring-ws Issues#1391</strong></a></p>\n<br>\n<h2>버전 비교를 통한 관찰</h2>\n<p>경고가 뜨지않는 Spring Boot 3.1.6와 경고가 뜨는 Spring Boot 3.2.0에서 문제가 되는 클래스를 비교해 보았습니다.</p>\n<p>보통 BeanPostProcessorChecker 경고는 특정 빈이 BeanPostProcessors의 모든 처리를 받기 전에 다른 빈에 의해 사용되거나 참조될 때 발생하게 됩니다.</p>\n<blockquote>\n<p>BeanPostProcessors는 빈의 초기화 과정 중 특정 시점에서 호출되어 추가적인 처리를 수행합니다. (postProcessBeforeInitialization, postProcessAfterInitialization)</p>\n</blockquote>\n<p>그래서 postProcessAfterInitialization 메서드에서 빈들의 후처리 과정을 관찰하다보니, 특정 빈들이 다른 빈들보다 먼저 처리되는 이상한 패턴이 발견되었습니다.</p>\n<p>메인 클래스 빈이 들어오기도 전에 배치, 데이터 소스, 트랜잭션과 관련된 빈들이 들어와 경고문구를 출력한 후 메인 클래스 초기화 이후에 또 다시 해당 빈들이 들어왔습니다.</p>\n<br>\n<p>아마 이 문제는 Spring Boot 3.2.0에서 변경된 내부 빈 초기화 메커니즘이 원인일 것 같습니다. 배치, 데이터 소스, 트랜잭션 관련 빈들이 메인 클래스보다 먼저 초기화되고 있으며, 이로 인해 이들 빈들 간의 의존성 관리와 초기화 순서에 문제가 발생하고 있는 것 같습니다.</p>\n<h2>로그 요약</h2>\n<details>\r\n    <summary>내용보기</summary>\n<br>\n<p><strong>Common Warning</strong></p>\n<p>The following beans are not eligible for being processed by all BeanPostProcessors (e.g., not eligible for auto-proxying). Please check if these beans are being eagerly injected into the currently created BeanPostProcessor [jobRegistryBeanPostProcessor] and review the corresponding BeanPostProcessor declaration and its dependencies:</p>\n<ul>\n<li>org.springframework.boot.autoconfigure.jdbc.DataSourceConfiguration$Hikari  <br></li>\n<li>spring.datasource-org.springframework.boot.autoconfigure.jdbc.DataSourceProperties <br></li>\n<li>org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration$PooledDataSourceConfiguration <br></li>\n<li>jdbcConnectionDetail`<br></li>\n<li>dataSourc` (com.zaxxer.hikari.HikariDataSource) <br></li>\n<li>org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration$ JdbcTransactionManagerConfiguration <br></li>\n<li>org.springframework.boot.autoconfigure.transaction.TransactionManagerCustomizationAutoConfiguration` <br></li>\n<li>transactionExecutionListeners <br></li>\n<li>spring.transaction-org.springframework.boot.autoconfigure.transaction.TransactionProperties <br></li>\n<li>platformTransactionManagerCustomizers <br></li>\n<li>transactionManager (org.springframework.jdbc.support.JdbcTransactionManager) <br></li>\n<li>spring.batch-org.springframework.boot.autoconfigure.batch.BatchProperties <br></li>\n</ul>\n<br>\n<p><strong>Another Warning</strong></p>\n<p>Bean 'org.springframework.boot.autoconfigure.batch.BatchAutoConfiguration\\$SpringBootBatchConfiguration' of type [org.springframework.boot.autoconfigure.batch.BatchAutoConfiguration$SpringBootBatchConfiguration] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying). The currently created BeanPostProcessor [jobRegistryBeanPostProcessor] is declared through a non-static factory method on that class; consider declaring it as static instead.</p>\r\n</details>","frontmatter":{"title":"Spring Boot 3.2에서의 Batch 처리 시 BeanPostProcessorChecker 경고","summary":"Spring Boot 3.2에서 Batch를 사용할 때 발생하는 BeanPostProcessorChecker 경고에 대한 포스트 입니다.","date":"2023.12.17.","categories":["Spring Batch","Problem"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/webp;base64,UklGRogAAABXRUJQVlA4IHwAAACQAwCdASoUAAsAPp0+mUgloyKhMAgAsBOJagCdAYs2yX5RDhYAAP76rL/qUWCEWi/BqMCQP5arQBdg5LJv27ejQQOhV0AQib6/F9GhsjNO2TiTc2S1WYvG+rPiCAJAVtFk0FeR8ShHOmvKB8cbJi1OUY0jNfW8K3tSkAAA"},"images":{"fallback":{"src":"/static/11bc629848dd9cb2140f9e014e5f16d9/a7f05/batch_bug_main.webp","srcSet":"/static/11bc629848dd9cb2140f9e014e5f16d9/41dd1/batch_bug_main.webp 448w,\n/static/11bc629848dd9cb2140f9e014e5f16d9/69efe/batch_bug_main.webp 896w,\n/static/11bc629848dd9cb2140f9e014e5f16d9/a7f05/batch_bug_main.webp 1792w","sizes":"(min-width: 1792px) 1792px, 100vw"},"sources":[]},"width":1792,"height":1024}},"publicURL":"/static/11bc629848dd9cb2140f9e014e5f16d9/batch_bug_main.webp"}}}}]}},"pageContext":{"slug":"/2023_12_17_boot3_2_batch_warn/"}},"staticQueryHashes":[],"slicesMap":{}}