{"componentChunkName":"component---src-templates-post-template-tsx","path":"/2023_12_16_batch_n_1_v17/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h1></h1>\n<p>기존 Spring Batch에서 JPA 사용시 발생하는 N+1 문제에 대해서 JDK 17, Spring Batch 5.0 이상 버전에서 발생하는 변경점을 확인하고자 합니다.</p>\n<p>Spring Batch에서 JPA 사용시 발생하는 N+1 문제 (JDK 11, Batch 4.2)  <a href=\"https://woosungkim0123.github.io/2023_12_12_batch_n_1/\" target=\"_blank\"><strong>블로그 글 </strong></a>, <a href=\"https://github.com/woosungkim0123/spring-batch-deep-dive/tree/main/n_1_v11\" target=\"_blank\"><strong>코드</strong></a></p>\n<p><a href=\"https://github.com/woosungkim0123/spring-batch-deep-dive/tree/main/n_1_v17/\" target=\"_blank\"><strong>Spring Batch에서 JPA 사용시 발생하는 N+1 문제 - JDK 17, Batch 5.0 이상 변경점 코드 </strong></a></p>\n<h2>Batch 5.0 이상 변경점</h2>\n<p>기존 코드에서 필요하다고 생각되는 부분만 다루었습니다.</p>\n<p>자세한 정보를 보시려면 <a href=\"https://github.com/spring-projects/spring-batch/wiki/Spring-Batch-5.0-Migration-Guide\" target=\"_blank\"><strong>링크</strong></a>를 참조해주세요.</p>\n<h3>Database 스키마 수정</h3>\n<p>Batch 5.0 이전 버전의 스키마를 그대로 사용하면 에러가 발생합니다.</p>\n<h4>1. JOB_CONFIGURATION_LOCATION</h4>\n<p>BATCH_JOB_EXECUTION 테이블 JOB_CONFIGURATION_LOCATION 열이 더이상 사용되지 않습니다.</p>\n<p><img src=\"/posts/batch/schema_change1.png\" alt=\"JOB_CONFIGURATION_LOCATION 사용 안됨\"></p>\n<p>5.0버전에서 해당 칼럼을 사용하는 Spring Batch의 유일한 부분인 JSR-352가 채택 부족으로 구현이 제거됨에 따라 사용처가 없어졌습니다.</p>\n<p><img src=\"/posts/batch/schema_change2.png\" alt=\"JOB_CONFIGURATION_LOCATION 사용 안됨 - 중요\"></p>\n<h4>2. BATCH_JOB_EXECUTION_PARAMS의 열 변경</h4>\n<p><a href=\"https://github.com/spring-projects/spring-batch/issues/3960\" target=\"_blank\"><strong> Issue #3960 </strong></a> 에서 Spring Boot 사용자에게 친숙한 Parameter 변경 제안이 있었는데 이를 반영한 것으로 보입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> BATCH_JOB_EXECUTION_PARAMS  <span class=\"token punctuation\">(</span>\r\n    JOB_EXECUTION_ID <span class=\"token keyword\">BIGINT</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token punctuation\">,</span>\r\n    <span class=\"token comment\">--\tTYPE_CD VARCHAR(6) NOT NULL , -- 제거</span>\r\n    <span class=\"token comment\">--\tKEY_NAME VARCHAR(100) NOT NULL , -- 제거</span>\r\n    <span class=\"token comment\">--\tSTRING_VAL VARCHAR(250) , -- 제거</span>\r\n    <span class=\"token comment\">--  DATE_VAL DATETIME(6) DEFAULT NULL , -- 제거</span>\r\n    <span class=\"token comment\">--\tLONG_VAL BIGINT , -- 제거</span>\r\n    <span class=\"token comment\">--\tDOUBLE_VAL DOUBLE PRECISION , -- 제거</span>\r\n    PARAMETER_NAME <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token punctuation\">,</span> <span class=\"token comment\">-- **추가**</span>\r\n    PARAMETER_TYPE <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token punctuation\">,</span> <span class=\"token comment\">-- **추가**</span>\r\n    PARAMETER_VALUE <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">2500</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">,</span> <span class=\"token comment\">-- **추가**</span>\r\n    IDENTIFYING <span class=\"token keyword\">CHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token keyword\">constraint</span> JOB_EXEC_PARAMS_FK <span class=\"token keyword\">foreign</span> <span class=\"token keyword\">key</span> <span class=\"token punctuation\">(</span>JOB_EXECUTION_ID<span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">references</span> BATCH_JOB_EXECUTION<span class=\"token punctuation\">(</span>JOB_EXECUTION_ID<span class=\"token punctuation\">)</span></code></pre></div>\n<h3>EnableBatchProcessing</h3>\n<p>Boot 3.0 이전에는 자동 구성을 활성화 하기 위해 @EnableBatchProcessing을 사용했습니다. 그러나 3.0 부터는 Spring Boot의 자동 구성을 사용하려면 제거해야합니다.</p>\n<p>@EnableBatchProcessing이나 DefaultBatchConfiguration을 확장하는 빈을 정의하면 Spring Boot의 자동 구성이 비활성화되고, 애플리케이션은 Spring Batch를 완전히 제어할 수 있습니다</p>\n<p><img src=\"/posts/batch/enableBatchProcessing.png\" alt=\"EnableBatchProcessing\"></p>\n<p>@EnableBatchProcessing에 새로운 속성이 추가되어, 어떤 구성 요소와 매개변수를 사용하여 Batch 인프라 빈을 구성할지 지정할 수 있습니다.</p>\n<p><code class=\"language-text\">@EnableBatchProcessing(dataSourceRef = \"dataSource1, transactionManagerRef = \"transactionManger1\")</code></p>\n<h3>Hibernate Reader Deprecated</h3>\n<p>HibernateCursorItemReader, HibernatePagingItemReader, HibernateItemWriter가 Deprecated 되었습니다. (관련 Builder 클래스 포함)</p>\n<p><img src=\"/posts/batch/deprecated1.png\" alt=\"HibernateCursorItemReader deprecated\"></p>\n<p><img src=\"/posts/batch/deprecated2.png\" alt=\"HibernatePagingItemReader deprecated\"></p>\n<p>ps. n_1_v17 프로젝트에서 HibernatePagingItemReader를 사용하는 예시 코드를 제거하였습니다.</p>\n<h3>JobBuilder, StepBuilder 사용 권장</h3>\n<p>JobBuilderFactory, StepBuilderFactory가 deprecated 되고 JobBuilder, StepBuilder 사용을 권장하고 있습니다.</p>\n<p><img src=\"/posts/batch/factory_depreacted.png\" alt=\"Factory deprecated\"></p>\n<h4>JobBuilderFactory, StepBuilderFactory를 deprecated 시킨 이유</h4>\n<ol>\n<li>\n<p>JobBuilderFactory는 내부적으로 JobRepository를 생성하고 설정하는데, 이 과정이 암시적으로 이루어지다보니 많은 사용자들, 특히 새로운 사용자들에게 혼란을 줄 수 있다고 했습니다.</p>\n</li>\n<li>\n<p>하나의 애플리케이션 내에서 여러 개의 JobRepository를 사용하는 경우들이 많은데 이를 변경하려면 BatchConfigurer라는 커스텀 클래스를 만들어서 JobBuilderFactory에 다른 JobRepository를 설정해야 하다보니 간편함과는 거리가 멀다고 했습니다.</p>\n</li>\n</ol>\n<p>위와 같은 이유 때문에 Spring Batch에서는 JobBuilderFactory의 사용을 권장하지 않고, 대신 더 명시적인 JobBuilder의 사용을 선호하게 되었다고 합니다.</p>\n<p>참고: <a href=\"https://github.com/spring-projects/spring-batch/issues/4188\" target=\"_blank\"><strong> Issue #4188 </strong></a></p>\n<h4>JobRepository와 TransactionManager의 사용 방식이 명시적으로 변경</h4>\n<p>JobBuilder, StepBuilder에 기존에 name만 받던 생성자를 JobRepository도 추가로 받도록 변경되었습니다.</p>\n<p><img src=\"/posts/batch/job_builder.png\" alt=\"job builder constructor\"></p>\n<p><img src=\"/posts/batch/step_builder.png\" alt=\"step builder constructor\"></p>\n<p>chunk 설정을 함에 있어 size 뿐만 아니라 transactionManager도 함께 받도록 변경하였습니다.</p>\n<p><img src=\"/posts/batch/chunk.png\" alt=\"chunk\"></p>\n<p>Batch 5.1 버전에서는 변경도 deprecated 시킴으로써 생성자를 통해 주입 받으면 이후 변경할 수 없게 되었습니다.</p>\n<p>더 명시적이고, 안정적인 방식으로 JobRepository와 TransactionManager를 관리하도록 한 것으로 보입니다.</p>\n<p><img src=\"/posts/batch/deprecated3.png\" alt=\"repository 변경 메서드 depreacted\"></p>\n<h2>Batch 코드 비교</h2>\n<p>Reader, Processor, Writer는 변경사항이 없어 생략했습니다.</p>\n<p>전체 코드를 확인하고 싶으시면 <a href=\"https://github.com/woosungkim0123/spring-batch-deep-dive/tree/main/n_1_v17/\" target=\"_blank\"><strong>이곳 </strong></a>에서 확인하실 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// v4</span>\r\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CustomJpaPagingReaderBatch</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// ...</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">JobBuilderFactory</span> jobBuilderFactory<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 5.0에서 deprecated</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">StepBuilderFactory</span> stepBuilderFactory<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 5.0에서 deprecated</span>\r\n    <span class=\"token comment\">// ...</span>\r\n    \r\n    <span class=\"token annotation punctuation\">@Bean</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token constant\">JOB_NAME</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Job</span> <span class=\"token function\">job</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">return</span> jobBuilderFactory<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JOB_NAME</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 5.0에서 jobBuilderFactory -> JobBuilder</span>\r\n                <span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token function\">step</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token annotation punctuation\">@Bean</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token constant\">STEP_NAME</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Step</span> <span class=\"token function\">step</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">return</span> stepBuilderFactory<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token constant\">STEP_NAME</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 5.0에서 stepBuilderFactory -> StepBuilder</span>\r\n                <span class=\"token punctuation\">.</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Store</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">StoreHistory</span><span class=\"token punctuation\">></span></span><span class=\"token function\">chunk</span><span class=\"token punctuation\">(</span>chunkSize<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 5.00에서 chunkSize, transactionManager 주입</span>\r\n                <span class=\"token punctuation\">.</span><span class=\"token function\">reader</span><span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">.</span><span class=\"token function\">reader</span><span class=\"token punctuation\">(</span><span class=\"token constant\">ADDRESS_PARAM</span><span class=\"token punctuation\">,</span> chunkSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n                <span class=\"token punctuation\">.</span><span class=\"token function\">processor</span><span class=\"token punctuation\">(</span>processor<span class=\"token punctuation\">)</span>\r\n                <span class=\"token punctuation\">.</span><span class=\"token function\">writer</span><span class=\"token punctuation\">(</span>writer<span class=\"token punctuation\">)</span>\r\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token comment\">// v5</span>\r\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CustomJpaPagingReaderBatch</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// ...</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">JobRepository</span> jobRepository<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 주입 1</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">PlatformTransactionManager</span> transactionManager<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 주입 2</span>\r\n    <span class=\"token comment\">// ...</span>\r\n    \r\n    <span class=\"token annotation punctuation\">@Bean</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token constant\">JOB_NAME</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Job</span> <span class=\"token function\">job</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JobBuilder</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JOB_NAME</span><span class=\"token punctuation\">,</span> jobRepository<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 변경 사항1: JobBuilder 사용, jobRepository 주입</span>\r\n                <span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token function\">step</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    \r\n    <span class=\"token annotation punctuation\">@Bean</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token constant\">STEP_NAME</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Step</span> <span class=\"token function\">step</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StepBuilder</span><span class=\"token punctuation\">(</span><span class=\"token constant\">STEP_NAME</span><span class=\"token punctuation\">,</span> jobRepository<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 변경 사항2: StepBuilder 사용, jobRepository 주입</span>\r\n                <span class=\"token punctuation\">.</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Store</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">StoreHistory</span><span class=\"token punctuation\">></span></span><span class=\"token function\">chunk</span><span class=\"token punctuation\">(</span>chunkSize<span class=\"token punctuation\">,</span> transactionManager<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 변경 사항3: transactionManager 주입</span>\r\n                <span class=\"token punctuation\">.</span><span class=\"token function\">reader</span><span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">.</span><span class=\"token function\">reader</span><span class=\"token punctuation\">(</span><span class=\"token constant\">ADDRESS_PARAM</span><span class=\"token punctuation\">,</span> chunkSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n                <span class=\"token punctuation\">.</span><span class=\"token function\">processor</span><span class=\"token punctuation\">(</span>processor<span class=\"token punctuation\">)</span>\r\n                <span class=\"token punctuation\">.</span><span class=\"token function\">writer</span><span class=\"token punctuation\">(</span>writer<span class=\"token punctuation\">)</span>\r\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>참조</h2>\n<p><a href=\"https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0.0-M5-Release-Notes#enablebatchprocessing-no-longer-required\" target=\"_blank\"><strong>Spring-Boot-3.0.0-M5-Release-Notes</strong></a></p>\n<p><a href=\"https://github.com/spring-projects/spring-batch/wiki/Spring-Batch-5.0-Migration-Guide\" target=\"_blank\"><strong>Spring Batch 5.0 Migration Guide</strong></a></p>","frontmatter":{"title":"Spring Batch JDK 17, Batch 5.0 이상 변경점 ","summary":"기존 Spring Batch에서 JPA 사용시 발생하는 N+1 문제에 대해서 JDK 17, Spring Batch 5.0 이상 버전에서 발생하는 변경점을 확인하고자 합니다.","date":"2023.12.16.","categories":["Spring Batch"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/webp;base64,UklGRqAAAABXRUJQVlA4IJQAAAAQBQCdASoUABQAPp1In0slpCKhqAgAsBOJZwAL0zA9ELrzyFImzsiiIrP0Ih+lU+f0AP73Vba4ym3V6VitZ+F0rwPu593dPf/2hto0LwaVNsVowEUuS8/mOVdbzPUPxdKoD9kZFwNVFp4wObhvrrUZm/6g/Bhkn2exXl7XSnmzYy+N6zimyVe3uJ7JI4mOm/AkAAAA"},"images":{"fallback":{"src":"/static/5f42a5a6da2480173de23a20325e43a4/af1dc/batch_main.webp","srcSet":"/static/5f42a5a6da2480173de23a20325e43a4/1697f/batch_main.webp 256w,\n/static/5f42a5a6da2480173de23a20325e43a4/6172c/batch_main.webp 512w,\n/static/5f42a5a6da2480173de23a20325e43a4/af1dc/batch_main.webp 1024w","sizes":"(min-width: 1024px) 1024px, 100vw"},"sources":[]},"width":1024,"height":1024}},"publicURL":"/static/5f42a5a6da2480173de23a20325e43a4/batch_main.webp"}}}}]}},"pageContext":{"slug":"/2023_12_16_batch_n_1_v17/"}},"staticQueryHashes":[],"slicesMap":{}}