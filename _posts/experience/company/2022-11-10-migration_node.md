---
title: node 서버 마이그레이션
author: woosungKim
date: 2022-11-10 19:00:00 +0800
categories: [경험, 회사]
tags: [node.js, migration]
---

<br>
<br>
<br>
<br>

회사에서 node.js 서버를 마이그레이션 했던 경험에 대해 이야기 해보고자 한다.

<br>

### 필요성

첫번째 문제는 앱 서비스에서 고화질 이미지가 지속적으로 업로드 되면서 모바일에서 이미지 로딩 속도가 3초 이상 걸리게 되었다.

처음에는 이미지의 용량을 제한하여 개선하려고 하였다. 
그러나 게시물 작성시 카메라 촬영 후 바로 업로드 되는 기능을 제공하고 있었고 카메라에서 촬영되는 이미지들이 모두 상당히 높은 용량을 가지고 있어 대부분의 사진이 업로드 되지 못하는 문제가 새로 발생하였다.

그래서 이미지 압축을 통해 개선하려고 하였다. 그러나 해당 서비스는 node 0.10.48 버전이였고 imagemagick, sharp등 다양한 압축 라이브러리들이 지원되지 않았다.

<br>

두번째 문제는 라우팅을 분리할 수 있는 기능이 지원되지 않아 app.js에 설정과 라우팅이 모두 모여 유지보수에 어려움을 겪었다.

<br>

이러한 문제를 해결하기 위해 node 14버전으로 마이그레이션을 진행하게 되었다.

<br>

### 마이그레이션

제일 먼저 Cafe24에서 가상 호스팅 서버를 구매하여 node 14버전을 설치하고 PM2를 활용하여 프로젝트를 실행하였다. 그리고 Apache Vhost를 이용하여 해당 서비스로 접근하도록 하였으며 SSL의 경우 기존 서버의 키를 그대로 들고와 설정해 주었다.

버전 차이로 충돌이 나는 코드와 deprecated된 코드를 모두 정리한 후 이미지 압축 라이브러리 sharp를 사용해 게시물 등록시 이미지를 압축하고 난 후 올리는 방식으로 변경하였고 app.js에서 라우팅과 설정을 모두 분리하였다. 

<br>

### 결과

이미지 로딩 시간을 <b>3초에서 0.8초</b>로 감소 시킬 수 있었다.

app.js에서 코드를 분리하여 <b>1000줄 -> 100줄</b>로 줄였다.

함수형 코드들을 클래스 형태로 모아 기능별로 캡슐화 하였다.

ES6형태의 문법으로 모두 개선하여 조금 더 직관적인 코드를 작성하였다.


<br>

### 2023년 4월 추가 생각

<b>도커 활용</b>

마이그레이션 전 서버에 리소스가 많이 남아 있었는데 기존 노드 버전의 충돌 때문에 마이그레이션을 진행하였고 그 당시 도커를 알고 사용했다면 버전 충돌 없이 프로젝트를 올릴 수 있었을 것 같다.
  
<b>코드 컨벤션</b>

마이그레이션 이후 코드 스타일을 대폭적으로 변경함에 따라 기존 인원들이 유지보수 할 때 어려움을 겪을 것 같다.
app.js에서 설정과 라우팅을 분리한 것과 controller에 응집된 코드들을 분리한 건 괜찮은 선택이였던 것 같지만 함수로 된 코드를 모두 Class형태로 변경한 것은 유지보수 측면에서 좋은 선택이 아니였던 것 같다.

<b>서버 구축 전략</b>

마이그레이션 당시에는 해당 프로젝트만을 생각하여서 크지 않은 가상 서버을 선택하였으나 추후 프로젝트들이 14버전으로 만들어 지는것 까지 고려하였다면 더 큰 서버를 구매하는게 맞는 선택인 것 같다.

