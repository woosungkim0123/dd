<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.13.3"/><style data-href="/styles.9e907bc32054b7771552.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#ccc;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}</style><link rel="canonical" href="https://woosungkim0123.github.io/2023_12_12_batch_n_1/" data-baseprotocol="https:" data-basehost="woosungkim0123.github.io"/><link rel="sitemap" type="application/xml" href="/sitemap-index.xml"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion="css 13ku56z">.css-13ku56z{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;height:100%;}</style><main class="css-13ku56z e1strnqo0"><style data-emotion="css-global 1fwq7nh">@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap');*{padding:0;margin:0;box-sizing:border-box;font-family:'Noto Sans KR','Nanum Myeongjo',serif;}html,body,#___gatsby{height:100%;}a,a:hover{color:inherit;-webkit-text-decoration:none;text-decoration:none;cursor:pointer;}</style><style data-emotion="css 16cz9yp">.css-16cz9yp{position:relative;width:100%;height:400px;}@media (max-width: 768px){.css-16cz9yp{height:300px;}}</style><div class="css-16cz9yp e1opi4mu1"><style data-emotion="css 1bjn9yo">.css-1bjn9yo{z-index:-1;width:100%;height:400px;object-fit:cover;-webkit-filter:brightness(0.25);filter:brightness(0.25);}@media (max-width: 768px){.css-1bjn9yo{height:300px;}}</style><div data-gatsby-image-wrapper="" style="position:absolute" class="gatsby-image-wrapper gatsby-image-wrapper-constrained css-1bjn9yo e1opi4mu0"><div style="max-width:1024px;display:block"><img alt="" role="presentation" aria-hidden="true" src="data:image/svg+xml;charset=utf-8,%3Csvg%20height=&#x27;1024&#x27;%20width=&#x27;1024&#x27;%20xmlns=&#x27;http://www.w3.org/2000/svg&#x27;%20version=&#x27;1.1&#x27;%3E%3C/svg%3E" style="max-width:100%;display:block;position:static"/></div><img aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear" decoding="async" src="data:image/webp;base64,UklGRqAAAABXRUJQVlA4IJQAAAAQBQCdASoUABQAPp1In0slpCKhqAgAsBOJZwAL0zA9ELrzyFImzsiiIrP0Ih+lU+f0AP73Vba4ym3V6VitZ+F0rwPu593dPf/2hto0LwaVNsVowEUuS8/mOVdbzPUPxdKoD9kZFwNVFp4wObhvrrUZm/6g/Bhkn2exXl7XSnmzYy+N6zimyVe3uJ7JI4mOm/AkAAAA" alt=""/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="(min-width: 1024px) 1024px, 100vw" decoding="async" loading="lazy" data-src="/static/5f42a5a6da2480173de23a20325e43a4/af1dc/batch_main.webp" data-srcset="/static/5f42a5a6da2480173de23a20325e43a4/1697f/batch_main.webp 256w,/static/5f42a5a6da2480173de23a20325e43a4/6172c/batch_main.webp 512w,/static/5f42a5a6da2480173de23a20325e43a4/af1dc/batch_main.webp 1024w" alt="thumbnail"/><noscript><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="(min-width: 1024px) 1024px, 100vw" decoding="async" loading="lazy" src="/static/5f42a5a6da2480173de23a20325e43a4/af1dc/batch_main.webp" srcSet="/static/5f42a5a6da2480173de23a20325e43a4/1697f/batch_main.webp 256w,/static/5f42a5a6da2480173de23a20325e43a4/6172c/batch_main.webp 512w,/static/5f42a5a6da2480173de23a20325e43a4/af1dc/batch_main.webp 1024w" alt="thumbnail"/></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1,e.parentNode.parentNode.querySelector("[data-placeholder-image]").style.opacity=0)}}</script></div><style data-emotion="css m1156n">.css-m1156n{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:768px;height:100%;margin:0 auto;padding:60px 0;color:#ffffff;}@media (max-width: 768px){.css-m1156n{width:100%;padding:40px 20px;}}</style><div class="css-m1156n e1st1jau4"><style data-emotion="css tyreyg">.css-tyreyg{display:grid;place-items:center;width:40px;height:40px;border-radius:50%;background:#ffffff;color:#000000;font-size:22px;cursor:pointer;box-shadow:0 0 10px rgba(0, 0, 0, 0.3);margin-bottom:68px;}@media (max-width: 768px){.css-tyreyg{width:30px;font-size:18px;margin-bottom:20px;}}</style><div class="css-tyreyg e1st1jau3"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="arrow-left" class="svg-inline--fa fa-arrow-left " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.2 288 416 288c17.7 0 32-14.3 32-32s-14.3-32-32-32l-306.7 0L214.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"></path></svg></div><style data-emotion="css 10lopry">.css-10lopry{display:-webkit-box;overflow:hidden;overflow-wrap:break-word;margin-top:auto;text-overflow:ellipsis;white-space:normal;-webkit-line-clamp:2;-webkit-box-orient:vertical;font-size:45px;font-weight:800;margin-bottom:10px;}@media (max-width: 768px){.css-10lopry{font-size:30px;}}</style><div class="css-10lopry e1st1jau2">Spring Batch에서 JPA 사용시 발생하는 N+1 문제</div><style data-emotion="css 3gcnt2">.css-3gcnt2{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin-top:10px;font-size:18px;font-weight:700;}@media (max-width: 768px){.css-3gcnt2{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;font-size:15px;font-weight:400;}}</style><div class="css-3gcnt2 e1st1jau1"><style data-emotion="css vqx3x2">.css-vqx3x2{margin-bottom:5px;}</style><div class="css-vqx3x2 e1st1jau0">Spring Batch / Problem</div><div class="css-vqx3x2 e1st1jau0">2023.12.12.</div></div></div></div><style data-emotion="css qalqfy">.css-qalqfy{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:768px;margin:0 auto;padding:0px 0 100px;word-break:break-all;line-height:1.8;font-size:16px;font-weight:400;}.css-qalqfy p{padding:3px 0;margin-bottom:5px;}.css-qalqfy h1,.css-qalqfy h2,.css-qalqfy h3{font-weight:800;margin-bottom:30px;}.css-qalqfy h1{margin-top:80px;}.css-qalqfy h2{margin-top:50px;}.css-qalqfy h3{margin-top:20px;}.css-qalqfy hr+h1,.css-qalqfy hr+h2,.css-qalqfy hr+h3{margin-top:0;}.css-qalqfy h1{font-size:30px;}.css-qalqfy h2{font-size:25px;}.css-qalqfy h3{font-size:20px;}.css-qalqfy blockquote{margin:30px 0;padding:5px 15px;border-left:2px solid #000000;font-weight:800;}.css-qalqfy ol,.css-qalqfy ul{margin-left:20px;padding:30px 0;}.css-qalqfy hr{border:1px solid #000000;margin:100px 0;}.css-qalqfy a{color:#4263eb;-webkit-text-decoration:underline;text-decoration:underline;}.css-qalqfy pre[class*='language-']{margin:30px 0;padding:15px;font-size:15px;}.css-qalqfy pre[class*='language-']::-webkit-scrollbar-thumb{background:rgba(255, 255, 255, 0.5);border-radius:3px;}.css-qalqfy code[class*='language-'],.css-qalqfy pre[class*='language-']{tab-size:2;}.css-qalqfy table{border-collapse:collapse;width:100%;}.css-qalqfy th{border:solid 1px #ccc;padding:8px;}.css-qalqfy td{border:solid 1px #ccc;padding:8px;}@media (max-width: 768px){.css-qalqfy{width:100%;padding:0px 20px 80px;line-height:1.6;font-size:14px;}.css-qalqfy h1{font-size:23px;}.css-qalqfy h2{font-size:20px;}.css-qalqfy h3{font-size:17px;}.css-qalqfy img{width:100%;display:block;margin-left:auto;margin-right:auto;}.css-qalqfy hr{margin:50px 0;}}</style><div class="css-qalqfy e1ijh0y10"><h1></h1>
<p>Spring Batch를 사용하면서 JPA를 통해 데이터를 처리할 때, 만날 수 있는 N+1 쿼리 문제에 대해서 해결을 위한 다양한 시도를 공유하고자 합니다.</p>
<p>코드:
<a href="https://github.com/woosungkim0123/spring-batch-deep-dive/tree/main/n_1_v11
" target="_blank"><strong>
Github</strong></a></p>
<h1>문제 상황</h1>
<p>조건에 맞는 Store를 StoreHistory로 백업하는 배치 작업에서, Store와 연관된 하위 도메인 두 개를 가져와서 배치 프로세서에서 처리하는 과정에서 N+1 쿼리가 발생하였습니다.</p>
<blockquote>
<p>N+1 문제</p>
<p>연관된 하위 엔티티에 접근할 때 각각 조회 쿼리가 발생하는 문제</p>
</blockquote>
<br>
<center>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/5d0e6328af6355cf75329d824b184be7/9f1c6/2023_12_12_batch_n_1_1.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 26.041666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAyklEQVR42iWPC46DMAxEuVIh/juBQrXSrmhKIu5/lhpWGo1sS/bzDKK6uHekg6WxhFekN2AUH+LjnnS1hvRDNAEw87au4zjWWofoXqYVUFieZlnEiZ3ImYuIAijg7P4E2NO1CinlnGO59z6AyMvsFympmjurxhnkS2wGRCEt2Yj+EpAKJChlnqapt3aRN5Ejod9XFpaZaGYOjzoDZMDVffsnC6eb/BgfLcgsEl9VohohI6Fq+I5YiZtZaAdq5l10RVQPhORSEOE8zy/x5kaiFFZmpgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/5d0e6328af6355cf75329d824b184be7/a59e9/2023_12_12_batch_n_1_1.webp 192w,
/static/5d0e6328af6355cf75329d824b184be7/0ca9f/2023_12_12_batch_n_1_1.webp 384w,
/static/5d0e6328af6355cf75329d824b184be7/dc9b9/2023_12_12_batch_n_1_1.webp 768w,
/static/5d0e6328af6355cf75329d824b184be7/a484c/2023_12_12_batch_n_1_1.webp 828w"
              sizes="(max-width: 768px) 100vw, 768px"
              type="image/webp"
            />
          <source
            srcset="/static/5d0e6328af6355cf75329d824b184be7/3b721/2023_12_12_batch_n_1_1.png 192w,
/static/5d0e6328af6355cf75329d824b184be7/66595/2023_12_12_batch_n_1_1.png 384w,
/static/5d0e6328af6355cf75329d824b184be7/fe486/2023_12_12_batch_n_1_1.png 768w,
/static/5d0e6328af6355cf75329d824b184be7/9f1c6/2023_12_12_batch_n_1_1.png 828w"
            sizes="(max-width: 768px) 100vw, 768px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/5d0e6328af6355cf75329d824b184be7/fe486/2023_12_12_batch_n_1_1.png"
            alt="N+1 문제"
            title=""
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
</center>
<br>
<h1>문제를 해결하기 위한 시도</h1>
<h2>Fetch Join 사용</h2>
<p>일반적으로 N+1 문제를 해결하기 위해 Fetch Join을 사용하게 되는데 이때 하위 엔티티를 동시에 2개 가져오려고 하면 MultipleBagFetchException이 발생하게 됩니다.</p>
<p>MultipleBagFetchException은 Hibernate가 두 개 이상의 리스트(List) 형태의 컬렉션을 동시에 가져오려 할 때 발생하는데, 결과 집합이 예상보다 커지고, 데이터 중복이 발생할 수 있기 때문입니다.</p>
<br>
<p>밑에 표는 부모 엔티티인 “Store”가 자식 엔티티인 “Product”와 “Employee”를 각각 2개 가지고 있을 때, 카테시안 곱(Cartesian Product)이 발생한 결과집합입니다.</p>
<blockquote>
<p>카테시안 곱(Cartesian Product)</p>
<p>SQL에서 두 테이블을 조인할 때, 한 테이블의 모든 행이 다른 테이블의 모든 행과 결합되는 현상을 말합니다.</p>
</blockquote>
<table>
<thead>
<tr>
<th>부모</th>
<th>자식1</th>
<th>자식2</th>
</tr>
</thead>
<tbody>
<tr>
<td>Store</td>
<td>Product1</td>
<td>Employee1</td>
</tr>
<tr>
<td>Store</td>
<td>Product1</td>
<td>Employee2</td>
</tr>
<tr>
<td>Store</td>
<td>Product2</td>
<td>Employee1</td>
</tr>
<tr>
<td>Store</td>
<td>Product2</td>
<td>Employee2</td>
</tr>
</tbody>
</table>
<br>
<p>Store가 4개가 중복된 것을 확인할 수 있습니다.</p>
<br>
<p>이런 상황에서 List 대신 Set을 사용하여 MultipleBagFetchException을 우회할 수 있습니다.</p>
<p>여기서 중복을 허용하지 않는 Set을 사용하게되면 중복된 결과가 제거되고 하이버 네이트는 중복없이 한 번씩만 처리하게 됩니다. 이러한 최적화로 복잡한 쿼리에서 MultipleBagFetchException 발생 가능성을 줄여줍니다.</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Store</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token annotation punctuation">@OneToMany</span><span class="token punctuation">(</span>mappedBy <span class="token operator">=</span> <span class="token string">"storeSet"</span><span class="token punctuation">,</span> cascade <span class="token operator">=</span> <span class="token constant">ALL</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductSet</span><span class="token punctuation">></span></span> products <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@OneToMany</span><span class="token punctuation">(</span>mappedBy <span class="token operator">=</span> <span class="token string">"storeSet"</span><span class="token punctuation">,</span> cascade <span class="token operator">=</span> <span class="token constant">ALL</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EmployeeSet</span><span class="token punctuation">></span></span> employees <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></div>
<br>
<center>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/0511734e522d71a73871c415c6482141/06fa9/2023_12_12_batch_n_1_2.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 15.104166666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAj0lEQVR42h2IuxKCMBRE+R/IREju+0bQGSspLLQQlM7a/+8MzpzdObuNuTGhIF9OcJtRABVrgxE5s1WIXQT6nlKqf4oxtm0MoQuh0VKuRBvw54zfGVegx2FYkSoL7HNFfrO8aO9nxk10yXAfsqk14zSZqqsK1xT/+zSOxd3NjqWYaPViFVPm4dBjzpBS6Lof8Okp2fGo3r8AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/0511734e522d71a73871c415c6482141/a59e9/2023_12_12_batch_n_1_2.webp 192w,
/static/0511734e522d71a73871c415c6482141/0ca9f/2023_12_12_batch_n_1_2.webp 384w,
/static/0511734e522d71a73871c415c6482141/dc9b9/2023_12_12_batch_n_1_2.webp 768w,
/static/0511734e522d71a73871c415c6482141/3a23a/2023_12_12_batch_n_1_2.webp 1017w"
              sizes="(max-width: 768px) 100vw, 768px"
              type="image/webp"
            />
          <source
            srcset="/static/0511734e522d71a73871c415c6482141/3b721/2023_12_12_batch_n_1_2.png 192w,
/static/0511734e522d71a73871c415c6482141/66595/2023_12_12_batch_n_1_2.png 384w,
/static/0511734e522d71a73871c415c6482141/fe486/2023_12_12_batch_n_1_2.png 768w,
/static/0511734e522d71a73871c415c6482141/06fa9/2023_12_12_batch_n_1_2.png 1017w"
            sizes="(max-width: 768px) 100vw, 768px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/0511734e522d71a73871c415c6482141/fe486/2023_12_12_batch_n_1_2.png"
            alt="set 사용 결과"
            title=""
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
</center>
<br>
<p>결과로 쿼리가 한번만 실행되었습니다. 그러나 경고도 같이 뜬 것을 볼 수 있습니다.</p>
<br>
<blockquote>
<p>o.h.h.internal.ast.QueryTranslatorImpl   : HHH000104: firstResult/maxResults specified with collection fetch; applying in memory!</p>
</blockquote>
<p>위 경고는 특정 쿼리에서 컬렉션을 fetch하는 동안 페이징(paging)을 적용하려고 시도했을 때 나타나게 됩니다.</p>
<p>Spring Batch에서는 데이터를 페이징해서 일정한 크기(chunk size)로 나누는데 여기에 Fetch join을 사용했기 때문에 해당 경고가 뜬 것입니다.</p>
<p>이 경우 쿼리 결과를 전부 메모리에 적재한 뒤 어플리케이션 레벨에서 페이징 작업을 수행하게 됩니다. 쿼리에서도 limit 절이 포함되지 않는 것을 확인할 수 있습니다.</p>
<br>
<center>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 571px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/a3f2f2af019f63987288e3c242f99f86/503dd/2023_12_12_batch_n_1_3.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 47.39583333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABJElEQVR42oVSS3aDMAzMZZpgwAb8BfN76U3aLrrq/ZcTSbzQJq+0iwFhrNGMpFNVVSjLEsMwYFkWjOOIlBL6vkfOAxK9Ywyw1sJ7B+e8xNpocO4zTvzw3u9Jzjm0bSuwtpMzYxopesdvRA+EXdchxCjKPCmQAhQ766CU2i/XdU2o/if0IYg1tsvKjDG7Sv6vVPmgkIscKRXCki5wMhPO84zX6xXrulJPV+kt95NbwYUDIZIbdnVIyBfYJieyujuahtFIrOVM7//q+o+hMFKfRFXOGZlUTdMkavmbSZsfhb5JDwhD8FJda70NKGyrscVkkwdEW9CRbUtOHJ1ZZ2VIB1O2Yjumzfq2RpGmTCtDu/dxUfh8KfB+LvBG+KJ4KRTOPPknwhvGIBk0/fql6gAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/a3f2f2af019f63987288e3c242f99f86/a59e9/2023_12_12_batch_n_1_3.webp 192w,
/static/a3f2f2af019f63987288e3c242f99f86/0ca9f/2023_12_12_batch_n_1_3.webp 384w,
/static/a3f2f2af019f63987288e3c242f99f86/b3aaa/2023_12_12_batch_n_1_3.webp 571w"
              sizes="(max-width: 571px) 100vw, 571px"
              type="image/webp"
            />
          <source
            srcset="/static/a3f2f2af019f63987288e3c242f99f86/3b721/2023_12_12_batch_n_1_3.png 192w,
/static/a3f2f2af019f63987288e3c242f99f86/66595/2023_12_12_batch_n_1_3.png 384w,
/static/a3f2f2af019f63987288e3c242f99f86/503dd/2023_12_12_batch_n_1_3.png 571w"
            sizes="(max-width: 571px) 100vw, 571px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/a3f2f2af019f63987288e3c242f99f86/503dd/2023_12_12_batch_n_1_3.png"
            alt="쿼리에 사용되지 않은 limit절"
            title=""
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
</center>
<br>
<p>이로 인해 많은 데이터를 다룰 때 메모리 부담이 증가하게 되며, 성능 저하로 이어질 수 있습니다.</p>
<br>
<h2>Batch Fetch Size 사용</h2>
<p>Fetch join 대신 Batch Fetch Size 조절을 통해서 N+1 문제를 효과적으로 관리할 수 있습니다.</p>
<p>Batch Fetch Size를 개별 엔티티 레벨과 전역 레벨에서 설정할 수 있으며, 개별 엔티티를 사용이 더 높은 우선순위를 가집니다.</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token comment">// 개별 엔티티 설정</span>
<span class="token annotation punctuation">@BatchSize</span><span class="token punctuation">(</span>size <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Store</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span></code></pre></div>
<div class="gatsby-highlight" data-language="properties"><pre class="language-properties"><code class="language-properties"><span class="token comment"># 전역 설정</span>
<span class="token key attr-name">spring.jpa.properties.hibernate.default_batch_fetch_size</span><span class="token punctuation">=</span><span class="token value attr-value">10</span></code></pre></div>
<p>Batch Fetch Size를 사용하게 되면 연관된 엔티티를 가져올 때 지정된 크기만큼의 데이터를 IN 쿼리로 한 번의 쿼리로 가져오게 됩니다.</p>
<p>예를들어 Store 엔티티가 여러 Product 엔티티와 연관되어 있고 batch fetch size가 10으로 설정된 경우, Store 엔티티와 관련된 Product 엔티티들을 로드할 때 한 번에 최대 10개의 Product 엔티티를 불러오는 IN 쿼리를 생성하게 됩니다.</p>
<br>
<center>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 532px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/a8ed09fb320573d8e6d58b1632bcc5a4/15ad6/2023_12_12_batch_n_1_4.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 27.604166666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAvklEQVR42qWMzWrDQAyE923sHUlJXP/sSlkX0p9DT72UQAK9ldIHSN6/8tYE2ms/htFIQgr0DwIxLXJz6CesOx+AqGFq3avaP8eoeMJvvI/ABigR5vIAJCz3NwXVrKr9MOScx3FMKZnpNE2e+5ye74aL7M677kzyzpuPFn2MCspEBgplv58rtoZ7x1/MpWSzhzKfrLyZvQ7jUfUlpWvXf247f/TF2yBckbXeEF4mxNKItOLOTfUD8SPoEPEU8Q2pikR07BrOXQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/a8ed09fb320573d8e6d58b1632bcc5a4/a59e9/2023_12_12_batch_n_1_4.webp 192w,
/static/a8ed09fb320573d8e6d58b1632bcc5a4/0ca9f/2023_12_12_batch_n_1_4.webp 384w,
/static/a8ed09fb320573d8e6d58b1632bcc5a4/939b7/2023_12_12_batch_n_1_4.webp 532w"
              sizes="(max-width: 532px) 100vw, 532px"
              type="image/webp"
            />
          <source
            srcset="/static/a8ed09fb320573d8e6d58b1632bcc5a4/3b721/2023_12_12_batch_n_1_4.png 192w,
/static/a8ed09fb320573d8e6d58b1632bcc5a4/66595/2023_12_12_batch_n_1_4.png 384w,
/static/a8ed09fb320573d8e6d58b1632bcc5a4/15ad6/2023_12_12_batch_n_1_4.png 532w"
            sizes="(max-width: 532px) 100vw, 532px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/a8ed09fb320573d8e6d58b1632bcc5a4/15ad6/2023_12_12_batch_n_1_4.png"
            alt="IN 쿼리 사용"
            title=""
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
</center>
<br>
<h3>JpaPagingItemReader 사용시 주의점</h3>
<p>Batch Fetch Size는 연관된 엔티티나 컬렉션을 로드할 때 일정 수의 엔티티를 한 번에 가져오도록 최적화하는 설정이며, 현재 진행 중인 트랜잭션 내에서 유효합니다.</p>
<br>
<p>일반적인 PagingItemReader의 경우, 트랜잭션을 Chunk에 맡김으로써 Chunk size의 처리가 끝날 때까지 하나의 트랜잭션으로 유지됩니다. 그래서 해당 설정이 전체 Chunk에 대해 일관되게 적용되어 최적화 효과를 얻을 수 있습니다. 그러나 JpaPagingItemReader는 페이징 처리를 위해 Reader 내부에서 각 페이지마다 별도의 트랜잭션을 사용하고 종료합니다. 이렇게 각 페이지마다 새로운 트랜잭션을 시작하고 종료하는 방식은 Batch Fetch Size 설정이 각 트랜잭션에 대해 개별적으로 적용되고, 트랜잭션이 종료될 때마다 초기화되는 결과를 가져옵니다.</p>
<p>이 경우, 각 페이지 로드에만 설정이 적용되므로 전체적인 배치 최적화 효과를 얻기 어렵습니다. 더욱이, JpaPagingItemReader의 사용은 IN 쿼리 최적화가 적용되지 않는 상황이 발생하게 됩니다 이는 Batch Fetch Size 설정이 효과적으로 작동하려면 연속된 트랜잭션 내에서 실행되어야 하는데, JpaPagingItemReader가 각 페이지 로딩 시 트랜잭션을 별도로 처리하기 때문입니다.</p>
<p>이 문제를 해결하기 위해 JpaPagingItemReader 내부의 트랜잭션을 제거하여 Chunk에게 트랜잭션을 맡기는 방식이 있습니다.</p>
<blockquote>
<p>내부에 트랜잭션을 제거하여 문제를 해결한 포스트<br>
링크: <a href="https://jojoldu.tistory.com/414" target="_blank"><strong><a href="https://jojoldu.tistory.com/414" target="_blank" rel="nofollow">https://jojoldu.tistory.com/414</a></strong></a></p>
</blockquote>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 542px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/d9dd3a065bfeb4180d96ae851712242b/47f85/2023_12_12_batch_n_1_5.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 31.770833333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA/0lEQVR42h2OW24CMQxFZ0NVmUxiX9tJDDOUUv7Ko+VRYP+7aAbJurKOZd3TLb26OwtIFWZJhFXLainZEnNkIGc2oxen14iqmYmg81qs1A3RzxBPMR2HeAzDBdLy0IdDGH4TteUY4r4PF+LvPhhQSiWirjWr+1+MX5BJdAI22UbGxFiLjMR1iJucG/9QHVVPi37Xit3B3NWSm9g5DE2wFwkCriWaLogH1b5BRpi5JNM3YPu+2Ikil/l51nY/pfQgXCE3yF3tmcs50d1y82zLlfG0fOP59AhxbTnXVpq7OUsBeAUZIUvmFfNabRT5LNUTOdEksnWfVFuWZqhSmi/wD0PXVPqAuHHkAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/d9dd3a065bfeb4180d96ae851712242b/a59e9/2023_12_12_batch_n_1_5.webp 192w,
/static/d9dd3a065bfeb4180d96ae851712242b/0ca9f/2023_12_12_batch_n_1_5.webp 384w,
/static/d9dd3a065bfeb4180d96ae851712242b/535ba/2023_12_12_batch_n_1_5.webp 542w"
              sizes="(max-width: 542px) 100vw, 542px"
              type="image/webp"
            />
          <source
            srcset="/static/d9dd3a065bfeb4180d96ae851712242b/3b721/2023_12_12_batch_n_1_5.png 192w,
/static/d9dd3a065bfeb4180d96ae851712242b/66595/2023_12_12_batch_n_1_5.png 384w,
/static/d9dd3a065bfeb4180d96ae851712242b/47f85/2023_12_12_batch_n_1_5.png 542w"
            sizes="(max-width: 542px) 100vw, 542px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/d9dd3a065bfeb4180d96ae851712242b/47f85/2023_12_12_batch_n_1_5.png"
            alt="IN 쿼리 적용"
            title=""
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<br>
<h2>Batch Fetch Size를 통한 해결</h2>
<h3>효과</h3>
<p>초기에 N+1 문제가 발생했을 때, 처리해야 할 데이터가 단 7개임에도 불구하고 총 7개의 쿼리가 필요했습니다. 만약 처리해야 할 데이터가 100개라면, 이 문제는 101개의 쿼리가 필요하게 되어 성능에 큰 부담을 주게 됩니다.</p>
<p>그러나 Batch Fetch Size 설정을 적용한 후에는 동일한 데이터 처리에 대해 이제는 단 3개의 쿼리만 발생하게 되었습니다.</p>
<h3>주의점</h3>
<p>Batch Fetch Size 값을 너무 높게 설정하면 많은 양의 데이터를 메모리에 로드하게 되면서 메모리 부족(OOM) 문제가 발생할 수 있습니다.</p>
<p>또한, 한 번의 쿼리에 많은 in 조건을 사용하면 데이터베이스 서버에 부담을 주어, 응답 시간이 증가하고 전반적인 시스템 성능이 저하될 수 있습니다.</p>
<p>메모리, 데이터베이스 성능, 요구 사항을 고려해서 성능 테스트를 통해 알맞는 값을 찾아야 할 것 같습니다.</p>
<h1>참조</h1>
<p><a href="https://docs.spring.io/spring-batch/docs/current/api/org/springframework/batch/item/database/JpaPagingItemReader.html" target="_blank"><strong>스프링 배치 공식문서 - JpaPagingItemReader</strong></a></p>
<p><a href="https://jojoldu.tistory.com/414" target="_blank"><strong>기억보단 기록을 - Spring Batch JPA에서 N+1 문제 해결</strong></a></p>
<p><a href="https://tecoble.techcourse.co.kr/post/2020-10-21-jpa-fetch-join-paging/" target="_blank"><strong>
Tecoble - JPA에서 Fetch Join과 Pagination을 함께 사용할때 주의하자</strong></a></p>
<p><a href="https://www.baeldung.com/java-hibernate-multiplebagfetchexception
" target="_blank"><strong>
A Guide to MultipleBagFetchException in Hibernate</strong></a></p></div><style data-emotion="css hx9xpc">@media (max-width: 768px){.css-hx9xpc{padding:0 20px;}}</style><div class="css-hx9xpc e1gqsjds0"></div><style data-emotion="css 9w9jmx">.css-9w9jmx{display:grid;place-items:center;margin-top:auto;padding:50px 0;font-size:15px;text-align:center;line-height:1.5;}@media (max-width: 768px){.css-9w9jmx{font-size:13px;}}</style><footer class="css-9w9jmx e1oae0v80"><br/>© 2024 Developer Woosung Kim, Powered By Gatsby.</footer></main></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2023_12_12_batch_n_1/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-cfadfbd9f3c4dbd90a87.js\"],\"component---src-pages-404-tsx\":[\"/component---src-pages-404-tsx-2f54b366957feba77712.js\"],\"component---src-pages-index-tsx\":[\"/component---src-pages-index-tsx-709185b09b2c5122aacc.js\"],\"component---src-templates-post-template-tsx\":[\"/component---src-templates-post-template-tsx-80da64d9c48e6431960b.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="bde08c3f31ec8ad22044";</script><script src="/webpack-runtime-8a0af140124af46932e8.js" async></script><script src="/framework-6a525285796fb83f2864.js" async></script><script src="/app-cfadfbd9f3c4dbd90a87.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>